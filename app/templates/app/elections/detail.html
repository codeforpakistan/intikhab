{% extends 'app/layouts/page.html' %}

{% block content %}
<!-- Election Header - Full Width -->
<div class="bg-success text-white py-4 mb-5">
  <div class="container">
    <header class="d-flex justify-content-between align-items-start">
      <div>
        <h1 class="mb-2">{{ election.name }}</h1>
        <p class="lead mb-2">{{ election.description }}</p>
        <small class="text-white-50">
          From {{ election.start_date|date:"M d, Y H:i" }} to {{ election.end_date|date:"M d, Y H:i" }}
        </small>
      </div>
      {% if request.user.is_superuser and election.active %}
      <div>
        <form method="post" action="{% url 'close_election' election.pk %}" onsubmit="return confirm('Are you sure you want to close this election? This action cannot be undone.');">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-stop-circle me-2"></i>Close Election
          </button>
        </form>
      </div>
      {% endif %}
    </header>
  </div>
</div>

<!-- Content Section -->
<div class="container pb-5">

<div class="row mb-4">
  <div class="col-md-6">
    <div class="card border-0">
      <div class="card-body">
        <h5 class="card-title">Election Status</h5>
        <p class="card-text">
          {% if election.is_voting_open %}
            <span class="badge bg-success">Voting Open</span>
          {% elif election.active %}
            <span class="badge bg-warning">Election Active but Voting Closed</span>
          {% else %}
            <span class="badge bg-secondary">Election Closed</span>
          {% endif %}
        </p>
        <p class="card-text">
          <strong>Total Votes:</strong> {{ election.votes.count }}
        </p>
      </div>
    </div>
  </div>
</div>

{% if vote_results %}
<div class="mb-5">
  <h3>Election Results</h3>
  <div class="card border-0">
    <div class="card-body">
      <p class="mb-4"><strong>Total Votes Cast:</strong> {{ vote_results.total_votes }}</p>
      
      {% for result in vote_results.results %}
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="d-flex align-items-center">
            {% if result.candidate.symbol %}
              <img src="{{ result.candidate.symbol.url }}" alt="{{ result.candidate.user.get_full_name }}" class="me-3" style="width: 40px; height: 40px; object-fit: cover;">
            {% endif %}
            <div>
              <h6 class="mb-0">{{ result.candidate.user.get_full_name }}</h6>
              {% if result.candidate.party %}
                <small class="text-muted">{{ result.candidate.party.name }}</small>
              {% endif %}
            </div>
          </div>
          <div class="text-end">
            <strong>{{ result.votes }} votes</strong>
            <div><small class="text-muted">{{ result.percentage }}%</small></div>
          </div>
        </div>
        <div class="progress" style="height: 8px;">
          <div class="progress-bar {% if forloop.first %}bg-success{% else %}bg-secondary{% endif %}" 
               role="progressbar" 
               style="width: {{ result.percentage }}%" 
               aria-valuenow="{{ result.percentage }}" 
               aria-valuemin="0" 
               aria-valuemax="100">
          </div>
        </div>
      </div>
      {% empty %}
      <p class="text-muted">No votes were cast in this election.</p>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

{% if voted %}
<div class="alert alert-info">
  <strong>Thank you!</strong> You have already voted in this election.
</div>
{% elif not election.is_voting_open %}
<div class="alert alert-warning">
  <strong>Voting Closed:</strong> Voting is not currently open for this election.
</div>
{% else %}
  <div class="row">
  {% for candidate in election.candidates.all %}
    <div class="col-md-4">
      <div class="card card-body">
        <h2 class="text-center">{{ candidate.user.get_username }}</h2>
        <p class="text-center"><img src="{{ candidate.symbol.url }}" width="170" height="170" alt="" class="img-fluid img-thumbnail"></p>
        <p class="mb-0 text-center"><a class="btn btn-primary" href="{% url 'vote' election.id candidate.id %}">VOTE</a></p>
      </div>
    </div>
  {% endfor %}

<h3>Candidates</h3>
<div class="row">
{% for candidate in election.candidates.all %}
<div class="col-md-4 mb-3">
  <div class="card border-0">
    <div class="card-body text-center">
      {% if candidate.symbol %}
        <img src="{{ candidate.symbol.url }}" alt="{{ candidate.user.get_full_name }}" class="img-fluid mb-2" style="max-height: 100px;">
      {% endif %}
      <h5 class="card-title">{{ candidate.user.get_full_name }}</h5>
      {% if candidate.party %}
        <p class="card-text">{{ candidate.party.name }}</p>
      {% endif %}
      <a class="btn btn-primary" href="{% url 'vote' election.id candidate.id %}">VOTE</a>
    </div>
  </div>
</div>
{% endfor %}
</div>

{% endif %}
{% if not election.active %}
  <div class="row">
    <div class="col-md-12">
      <h2>Election Results</h2>
      <p>Decrypted Total: {{ election.decrypted_total }}</p>
      <button class="btn btn-primary" hx-get="{% url 'verify_results' election.id %}" hx-target="#results">Verify Results</button>
      <div id="results"></div>
    </div>
  </div>
{% endif %}
{% endblock %}